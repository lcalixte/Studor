<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STUDOR - Le Jeu de l'Orientation</title>
    
    <!-- STYLE -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SCRIPTS CRITIQUES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin="anonymous" onerror="alert('Erreur : Impossible de charger React. Vérifiez votre connexion.')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous" onerror="alert('Erreur : Impossible de charger ReactDOM.')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin="anonymous" onerror="alert('Erreur : Impossible de charger Babel.')"></script>
    
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        body { margin: 0; padding: 0; overflow: hidden; background-color: #0f172a; color: white; }
        #error-display { display: none; padding: 20px; background: #fee2e2; color: #991b1b; border-bottom: 4px solid #7f1d1d; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; font-family: sans-serif; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* --- CSS DÉS 3D --- */
        .scene { width: 60px; height: 60px; perspective: 600px; display: inline-block; margin: 10px; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1s ease-out; }
        .cube__face { position: absolute; width: 60px; height: 60px; border: 2px solid #b91c1c; background: white; border-radius: 10px; display: flex; justify-content: center; align-items: center; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }
        .cube__face--1 { transform: rotateY(  0deg) translateZ(30px); }
        .cube__face--2 { transform: rotateY( 90deg) translateZ(30px); }
        .cube__face--3 { transform: rotateY(180deg) translateZ(30px); }
        .cube__face--4 { transform: rotateY(-90deg) translateZ(30px); }
        .cube__face--5 { transform: rotateX( 90deg) translateZ(30px); }
        .cube__face--6 { transform: rotateX(-90deg) translateZ(30px); }
        
        .dot { width: 10px; height: 10px; background-color: #dc2626; border-radius: 50%; position: absolute; }
        .face-1 .dot:nth-child(1) { top: 25px; left: 25px; }
        .face-2 .dot:nth-child(1) { top: 10px; left: 10px; } .face-2 .dot:nth-child(2) { bottom: 10px; right: 10px; }
        .face-3 .dot:nth-child(1) { top: 10px; left: 10px; } .face-3 .dot:nth-child(2) { top: 25px; left: 25px; } .face-3 .dot:nth-child(3) { bottom: 10px; right: 10px; }
        .face-4 .dot:nth-child(1) { top: 10px; left: 10px; } .face-4 .dot:nth-child(2) { top: 10px; right: 10px; } .face-4 .dot:nth-child(3) { bottom: 10px; left: 10px; } .face-4 .dot:nth-child(4) { bottom: 10px; right: 10px; }
        .face-5 .dot:nth-child(1) { top: 10px; left: 10px; } .face-5 .dot:nth-child(2) { top: 10px; right: 10px; } .face-5 .dot:nth-child(3) { top: 25px; left: 25px; } .face-5 .dot:nth-child(4) { bottom: 10px; left: 10px; } .face-5 .dot:nth-child(5) { bottom: 10px; right: 10px; }
        .face-6 .dot:nth-child(1) { top: 10px; left: 10px; } .face-6 .dot:nth-child(2) { top: 10px; right: 10px; } .face-6 .dot:nth-child(3) { top: 25px; left: 10px; } .face-6 .dot:nth-child(4) { top: 25px; right: 10px; } .face-6 .dot:nth-child(5) { bottom: 10px; left: 10px; } .face-6 .dot:nth-child(6) { bottom: 10px; right: 10px; }

        @keyframes spin { from { transform: rotateX(0) rotateY(0); } to { transform: rotateX(360deg) rotateY(720deg); } }
        .is-spinning { animation: spin 0.3s infinite linear; }
    </style>
</head>
<body>
    <div id="error-display"></div>
    <div id="root"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            var display = document.getElementById('error-display');
            display.style.display = 'block';
            display.innerHTML = "<strong>Oups ! Une erreur est survenue :</strong><br>" + message + "<br><small>Ligne: " + lineno + "</small>";
        };
    </script>

    <script type="text/babel">
        try {
            const { useState, useEffect, useRef } = React;

            // --- ICONES ---
            const DiceIcon = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M16 8h.01"/><path d="M8 8h.01"/><path d="M8 16h.01"/><path d="M16 16h.01"/><path d="M12 12h.01"/></svg>);
            const User = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>);
            const Trophy = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>);
            const CheckCircle = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>);
            const XCircle = (props) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>);

            // --- DONNEES ---
            const ROOMS = [
                { id: "cio", name: "Centre d'info & Orientation", x: 6, y: 0, w: 3, h: 3, color: "bg-blue-600", door: { x: 7, y: 3 }, entryDirection: "down" },
                { id: "sport", name: "Mes amis du sport", x: 0, y: 0, w: 3, h: 3, color: "bg-orange-500", door: { x: 3, y: 1 }, entryDirection: "right" },
                { id: "amis", name: "Mes amis", x: 12, y: 0, w: 3, h: 3, color: "bg-pink-500", door: { x: 11, y: 1 }, entryDirection: "left" },
                { id: "weekend", name: "Sorties du week-end", x: 0, y: 5, w: 3, h: 4, color: "bg-purple-500", door: { x: 3, y: 6 }, entryDirection: "right" },
                { id: "bureau", name: "Bureau", x: 12, y: 4, w: 3, h: 3, color: "bg-slate-600", door: { x: 11, y: 5 }, entryDirection: "left" },
                { id: "biblio", name: "Bibliothèque", x: 12, y: 8, w: 3, h: 3, color: "bg-indigo-600", door: { x: 11, y: 9 }, entryDirection: "left" },
                { id: "parents", name: "Mes parents", x: 0, y: 11, w: 3, h: 4, color: "bg-teal-600", door: { x: 3, y: 12 }, entryDirection: "right" },
                { id: "internet", name: "Internet", x: 6, y: 11, w: 3, h: 4, color: "bg-cyan-600", door: { x: 7, y: 10 }, entryDirection: "up" },
                { id: "studio", name: "Studio", x: 12, y: 12, w: 3, h: 3, color: "bg-red-500", door: { x: 11, y: 12 }, entryDirection: "left" },
            ];

            const FULL_CARDS_DB = [
                {
                    id: "admission_parallele",
                    title: "ADMISSION PARALLÈLE",
                    question: "L'admission parallèle permet d'intégrer une Grande École :",
                    options: [
                        { text: "Via un concours après un BTS, BUT ou Licence", correct: true },
                        { text: "Uniquement si on connaît le directeur", correct: false },
                        { text: "Seulement après une classe prépa", correct: false }
                    ],
                    explanation: "Les grandes écoles admettent aussi des étudiants issus de BTS, BUT, licence, ou bachelor, souvent via un concours commun (Passerelle, Tremplin...)."
                },
                {
                    id: "alternance",
                    title: "ALTERNANCE",
                    question: "Quel est l'avantage financier principal de l'alternance ?",
                    options: [
                        { text: "L'étudiant est rémunéré et ne paie pas ses frais", correct: true },
                        { text: "L'école paie le loyer de l'étudiant", correct: false },
                        { text: "L'étudiant gagne au loto chaque mois", correct: false }
                    ],
                    explanation: "L'étudiant est rémunéré (selon le Smic, l'âge et le niveau) et ne paye pas ses frais de scolarité."
                },
                {
                    id: "bachelor",
                    title: "BACHELOR",
                    question: "Le Bachelor est une formation qui dure généralement :",
                    options: [
                        { text: "3 ans (ou 4 ans pour un BBA)", correct: true },
                        { text: "6 mois intensifs", correct: false },
                        { text: "10 ans, le temps de bien réfléchir", correct: false }
                    ],
                    explanation: "Ce titre en trois ans (ou 4 ans) après le bac est proposé par de nombreuses écoles. Attention aux labels (Visa, Grade) !"
                },
                {
                    id: "bts",
                    title: "BTS",
                    question: "Un BTS est :",
                    options: [
                        { text: "Une Betterave Très Sensible", correct: false },
                        { text: "Un Brevet de Technicien Supérieur", correct: true },
                        { text: "Un Baccalauréat Très Scientifique", correct: false }
                    ],
                    explanation: "Le BTS est un diplôme national en deux ans très professionnalisant, dispensé en lycée ou CFA."
                },
                {
                    id: "but",
                    title: "BUT",
                    question: "Le BUT (Bachelor Universitaire de Technologie) se prépare en :",
                    options: [
                        { text: "3 ans en IUT", correct: true },
                        { text: "2 ans en IUT", correct: false },
                        { text: "4 ans en école de commerce", correct: false }
                    ],
                    explanation: "Accessible après le bac, l'enseignement se déroule au sein d'un Institut universitaire de technologie (IUT) sur 3 ans."
                },
                {
                    id: "dnmade",
                    title: "DNMADE",
                    question: "Le DNMADE est un diplôme spécialisé dans :",
                    options: [
                        { text: "Les métiers d'art et du design", correct: true },
                        { text: "Le dressage de navires maritimes", correct: false },
                        { text: "La distribution numérique moderne", correct: false }
                    ],
                    explanation: "Formation en 3 ans (Boulle, Estienne...) avec 14 spécialités comme l'architecture d'intérieur ou l'animation."
                },
                {
                    id: "dcg",
                    title: "DCG",
                    question: "Le DCG (Diplôme de Comptabilité et Gestion) offre le grade de :",
                    options: [
                        { text: "Licence", correct: true },
                        { text: "Général des armées", correct: false },
                        { text: "Master", correct: false }
                    ],
                    explanation: "Il se prépare en 3 ans et permet de poursuivre vers l'expertise comptable (DSCG puis DEC)."
                },
                {
                    id: "erasmus",
                    title: "ERASMUS",
                    question: "Le programme Erasmus permet d'étudier à l'étranger pendant :",
                    options: [
                        { text: "12 mois maximum par cycle", correct: true },
                        { text: "Tout le cursus (3 à 5 ans)", correct: false },
                        { text: "Juste le week-end", correct: false }
                    ],
                    explanation: "Financé par l'UE, il permet de suivre sa formation dans un autre pays européen avec une aide financière."
                },
                {
                    id: "iae",
                    title: "IAE",
                    question: "Un IAE (Institut d'Administration des Entreprises) c'est :",
                    options: [
                        { text: "Une école de commerce à l'université", correct: true },
                        { text: "Un Institut d'Art Égyptien", correct: false },
                        { text: "Une taxe sur les entreprises", correct: false }
                    ],
                    explanation: "Ce sont des écoles de commerce publiques universitaires, avec des frais de scolarité très réduits (env. 250€)."
                },
                {
                    id: "iep",
                    title: "IEP",
                    question: "Outre Paris, combien y a-t-il d'IEP (Sciences Po) en région ?",
                    options: [
                        { text: "10 (Lille, Lyon, Bordeaux...)", correct: true },
                        { text: "Aucun, tout est à Paris", correct: false },
                        { text: "2 (Marseille et Brest)", correct: false }
                    ],
                    explanation: "Il existe 10 autres Instituts d'études politiques comme Grenoble, Bordeaux, Lille, Lyon, etc."
                },
                {
                    id: "ifsi",
                    title: "IFSI",
                    question: "En IFSI, on apprend le métier :",
                    options: [
                        { text: "D'infirmier", correct: true },
                        { text: "D'informaticien sans internet", correct: false },
                        { text: "D'ingénieur fiscal", correct: false }
                    ],
                    explanation: "Ces instituts permettent de décrocher en trois ans le diplôme d'État d'infirmier (théorie + stages)."
                },
                {
                    id: "las",
                    title: "LAS",
                    question: "La LAS (Licence Accès Santé) permet :",
                    options: [
                        { text: "De tenter médecine avec une majeure (Droit, Éco...)", correct: true },
                        { text: "D'apprendre à faire des lacets", correct: false },
                        { text: "D'accéder à la santé sans diplôme", correct: false }
                    ],
                    explanation: "Constituée d'une majeure au choix et d'une mineure santé. Si on valide, on peut candidater en santé."
                },
                {
                    id: "master",
                    title: "MASTER vs MASTÈRE",
                    question: "Lequel est un Diplôme National reconnu par l'État (Bac+5) ?",
                    options: [
                        { text: "Le Master (délivré par l'université)", correct: true },
                        { text: "Le Mastère (label d'école)", correct: false },
                        { text: "Le Mister", correct: false }
                    ],
                    explanation: "Attention ! Le Master est un diplôme national. Le Mastère est un titre propre à une école (non protégé)."
                },
                {
                    id: "pass",
                    title: "PASS",
                    question: "En PASS (Parcours Accès Santé Spécifique), si on rate l'année :",
                    options: [
                        { text: "On ne peut pas redoubler le PASS", correct: true },
                        { text: "On redouble automatiquement", correct: false },
                        { text: "On passe en 2ème année de médecine directement", correct: false }
                    ],
                    explanation: "Le redoublement est interdit en PASS. Il faut se réorienter (souvent vers une LAS) si on échoue."
                },
                {
                    id: "labels",
                    title: "LABELS",
                    question: "Que sont AACSB, Equis et Amba pour les écoles de commerce ?",
                    options: [
                        { text: "Des accréditations internationales prestigieuses", correct: true },
                        { text: "Des groupes de musique K-Pop", correct: false },
                        { text: "Des marques de vêtements étudiants", correct: false }
                    ],
                    explanation: "Ces labels garantissent la qualité des enseignements. Certaines écoles ont la triple accréditation."
                },
                {
                    id: "pge",
                    title: "PGE",
                    question: "Que signifie l'acronyme PGE ?",
                    options: [
                        { text: "Programme Grande École", correct: true },
                        { text: "Petit Garçon Énervé", correct: false },
                        { text: "Prépa Gestion Économie", correct: false }
                    ],
                    explanation: "C'est le cursus phare des écoles de commerce, menant au grade de Master (souvent après une prépa)."
                },
                {
                    id: "cpge",
                    title: "CPGE",
                    question: "Les CPGE (Classes Préparatoires) préparent en :",
                    options: [
                        { text: "2 ans", correct: true },
                        { text: "5 ans", correct: false },
                        { text: "6 mois", correct: false }
                    ],
                    explanation: "Elles préparent aux concours des grandes écoles (commerce, ingénieurs, ENS) en deux ans intensifs."
                },
                {
                    id: "al",
                    title: "PRÉPA A/L",
                    question: "La prépa littéraire A/L (Lettres) mène principalement :",
                    options: [
                        { text: "Aux ENS et à l'École des Chartes", correct: true },
                        { text: "Aux écoles de cuisine", correct: false },
                        { text: "Au concours de médecine", correct: false }
                    ],
                    explanation: "Elle propose français, philo, histoire, langues... En 2e année, on l'appelle la Khâgne."
                },
                {
                    id: "bcpst",
                    title: "BCPST",
                    question: "La filière BCPST est la voie idéale pour devenir :",
                    options: [
                        { text: "Vétérinaire ou ingénieur agronome", correct: true },
                        { text: "Banquier ou assureur", correct: false },
                        { text: "Professeur de sport", correct: false }
                    ],
                    explanation: "Biologie, Chimie, Physique et Sciences de la Terre. Elle mène aussi à l'École Polytechnique."
                },
                {
                    id: "ecg",
                    title: "ECG",
                    question: "La prépa ECG s'adresse aux bacheliers :",
                    options: [
                        { text: "Généraux (profil éco/maths)", correct: true },
                        { text: "Technologiques uniquement", correct: false },
                        { text: "Professionnels", correct: false }
                    ],
                    explanation: "C'est la voie générale de la prépa économique et commerciale, née de la fusion ECE/ECS."
                },
                {
                    id: "mp2i",
                    title: "MP2I",
                    question: "La prépa MP2I met l'accent particulièrement sur :",
                    options: [
                        { text: "L'informatique", correct: true },
                        { text: "La mécanique automobile", correct: false },
                        { text: "La philosophie ancienne", correct: false }
                    ],
                    explanation: "Maths, Physique, Ingénierie et Informatique. Destinée aux bacheliers attirés par le numérique."
                },
                {
                    id: "kholles",
                    title: "KHÔLLES",
                    question: "Une Khôlle en prépa, c'est :",
                    options: [
                        { text: "Une interrogation orale intensive", correct: true },
                        { text: "Un tube de colle très fort", correct: false },
                        { text: "Une soirée étudiante costumée", correct: false }
                    ],
                    explanation: "Ce sont des oraux intensifs (2 à 3 fois par semaine) pour s'entraîner aux concours devant un prof."
                },
                {
                    id: "5demi",
                    title: "3/2 ET 5/2",
                    question: "Faire 5/2 en jargon de prépa signifie :",
                    options: [
                        { text: "Redoubler sa 2ème année pour retenter les concours", correct: true },
                        { text: "Avoir une moyenne de 2,5/20", correct: false },
                        { text: "Travailler 5 jours sur 2", correct: false }
                    ],
                    explanation: "Le 3/2 réussit du premier coup. Le 5/2 redouble pour avoir une meilleure école (intégrale de 2 à 3)."
                },
                {
                    id: "khagne",
                    title: "KHÂGNE",
                    question: "La Khâgne est le surnom de :",
                    options: [
                        { text: "La 2ème année de prépa littéraire", correct: true },
                        { text: "La cantine de la prépa", correct: false },
                        { text: "La bibliothèque du lycée", correct: false }
                    ],
                    explanation: "Les littéraires vont en Hypokhâgne (1ère année) puis en Khâgne (2ème année)."
                },
                {
                    id: "taupe",
                    title: "TAUPE",
                    question: "En argot scolaire, une Taupe désigne :",
                    options: [
                        { text: "Une classe prépa scientifique", correct: true },
                        { text: "Un espion dans la classe", correct: false },
                        { text: "Un élève qui dort tout le temps", correct: false }
                    ],
                    explanation: "Les étudiants taupins travaillent sans voir le jour, comme l'animal, et préparent le concours des Mines."
                }
            ];

            // --- COMPOSANTS DÉ 3D ---
            const Dice3D = ({ value, rolling }) => {
                const getRotation = (val) => {
                    switch(val) {
                        case 1: return 'rotateY(0deg) rotateX(0deg)';
                        case 2: return 'rotateY(90deg) rotateX(0deg)'; // Face droite
                        case 3: return 'rotateY(180deg) rotateX(0deg)'; // Face arrière
                        case 4: return 'rotateY(-90deg) rotateX(0deg)'; // Face gauche
                        case 5: return 'rotateX(-90deg)'; // Face haut
                        case 6: return 'rotateX(90deg)'; // Face bas
                        default: return 'rotateY(0deg)';
                    }
                };

                return (
                    <div className="scene">
                        <div className={`cube ${rolling ? 'is-spinning' : ''}`} 
                             style={{ transform: rolling ? '' : getRotation(value) }}>
                            <div className="cube__face cube__face--1 face-1"><div className="dot"></div></div>
                            <div className="cube__face cube__face--2 face-4"><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div></div>
                            <div className="cube__face cube__face--3 face-3"><div className="dot"></div><div className="dot"></div><div className="dot"></div></div>
                            <div className="cube__face cube__face--4 face-2"><div className="dot"></div><div className="dot"></div></div>
                            <div className="cube__face cube__face--5 face-5"><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div></div>
                            <div className="cube__face cube__face--6 face-6"><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div></div>
                        </div>
                    </div>
                );
            };

            // --- LOGO FIGARO ---
            const FigaroLogo = () => (
                <svg viewBox="0 0 100 100" className="w-full h-full" xmlns="http://www.w3.org/2000/svg">
                    <rect width="100" height="100" fill="#E75936" />
                    <path d="M35 25 h40 v12 h-25 v12 h20 v12 h-20 v20 h-15 z" fill="white" />
                    <path d="M20 10 Q 15 35, 35 50 Q 55 65, 80 80 L 75 85 Q 45 70, 20 45 Q 10 25, 20 10 Z" fill="white" />
                    <text x="50" y="92" fontFamily="Arial, sans-serif" fontWeight="800" fontSize="14" textAnchor="middle" fill="white">étudiant</text>
                </svg>
            );

            // --- COMPOSANTS JEU ---
            const GridCell = ({ x, y, isPath, isRoom, roomData, playerPos, isReachable, onClick }) => {
                const isPlayerHere = playerPos.x === x && playerPos.y === y;
                let baseClasses = "w-full h-full border border-slate-800/50 transition-all duration-200 ";
                if (isRoom) {
                    baseClasses += `${roomData.color} `;
                } else if (isPath) {
                    baseClasses += "bg-slate-200/5 ";
                } else {
                    baseClasses += "bg-slate-950 ";
                }

                if (isPlayerHere) {
                    baseClasses += "bg-yellow-400 flex items-center justify-center shadow-[0_0_15px_rgba(250,204,21,0.6)] z-20 relative rounded-full scale-90 ";
                } else if (isReachable) {
                    baseClasses += "bg-green-500/50 cursor-pointer hover:bg-green-400/70 animate-pulse border-2 border-green-400 z-20 relative ";
                }

                return (
                    <div 
                        className={baseClasses} 
                        onClick={() => isReachable ? onClick(x, y) : null}
                        style={{ gridColumnStart: x + 1, gridRowStart: y + 1 }}
                    >
                        {isPlayerHere && <User className="text-slate-900 w-5 h-5 md:w-6 md:h-6" />}
                    </div>
                );
            };

            const RoomOverlay = ({ room, playerPos }) => {
                const isPlayerInside = playerPos.x >= room.x && playerPos.x < room.x + room.w && playerPos.y >= room.y && playerPos.y < room.y + room.h;
                return (
                    <div 
                        className={`absolute flex flex-col items-center justify-center text-white font-bold text-xs md:text-sm text-center p-1 transition-transform pointer-events-none`}
                        style={{
                            gridColumnStart: room.x + 1,
                            gridColumnEnd: room.x + room.w + 1,
                            gridRowStart: room.y + 1,
                            gridRowEnd: room.y + room.h + 1,
                            zIndex: 10,
                        }}
                    >
                        <span className="uppercase tracking-wide drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] text-[0.65rem] md:text-xs leading-tight px-1 text-white">
                            {room.name}
                        </span>
                        {isPlayerInside && <User className="text-white w-6 h-6 md:w-8 md:h-8 mt-1 animate-bounce filter drop-shadow-lg opacity-90" />}
                        <div 
                            className="absolute w-3 h-3 md:w-4 md:h-4 bg-yellow-400 border-2 border-slate-900 rounded-full animate-pulse shadow-lg"
                            style={{
                                left: room.entryDirection === 'left' ? '-6px' : room.entryDirection === 'right' ? 'auto' : '50%',
                                right: room.entryDirection === 'right' ? '-6px' : 'auto',
                                top: room.entryDirection === 'up' ? '-6px' : room.entryDirection === 'down' ? 'auto' : '50%',
                                bottom: room.entryDirection === 'down' ? '-6px' : 'auto',
                                transform: (room.entryDirection === 'up' || room.entryDirection === 'down') ? 'translateX(-50%)' : 'translateY(-50%)'
                            }}
                        />
                    </div>
                );
            };

            function StudorGame() {
                const [playerPos, setPlayerPos] = useState({ x: 7, y: 3 }); 
                const [diceValues, setDiceValues] = useState([1, 1]); // Valeurs des 2 dés
                const [isRolling, setIsRolling] = useState(false);
                const [movesLeft, setMovesLeft] = useState(0);
                const [gameState, setGameState] = useState('start');
                const [currentMessage, setCurrentMessage] = useState("Bienvenue au CIO ! Lance les dés pour explorer.");
                const [activeCard, setActiveCard] = useState(null);
                const [completedCards, setCompletedCards] = useState([]); 
                const [showFeedback, setShowFeedback] = useState(null);
                const [logoRotation, setLogoRotation] = useState(0);

                const GRID_SIZE = 15;

                const isWalkable = (x, y) => {
                    const inRoom = ROOMS.find(r => x >= r.x && x < r.x + r.w && y >= r.y && y < r.y + r.h);
                    if (inRoom) return true;
                    if (x >= 5 && x <= 9 && y >= 5 && y <= 9) return false;
                    return true;
                };

                const handleRollDice = () => {
                    setGameState('rolling');
                    setIsRolling(true);
                    
                    // On laisse tourner les dés pendant 2 secondes
                    setTimeout(() => {
                        const d1 = Math.floor(Math.random() * 6) + 1;
                        const d2 = Math.floor(Math.random() * 6) + 1;
                        const total = d1 + d2;
                        
                        setDiceValues([d1, d2]);
                        setMovesLeft(total);
                        setIsRolling(false);
                        setGameState('moving');
                        
                        // Nouveau message d'instructions demandé
                        setCurrentMessage(`Tu as fait ${total} ! Déplace-toi vers une pièce. Clique sur 1 des 4 cases vertes pour te déplacer vers le lieu de ton choix, et continue de progresser ainsi de case en case. Si tu n'as pas assez de points pour continuer, clique sur "Lancer les dés". ATTENTION : Si tu ne vois pas apparaître la question, swype vers le haut de l'écran.`);
                    }, 2000);
                };

                const getReachableTiles = () => {
                    if (gameState !== 'moving' || movesLeft === 0) return [];
                    const adj = [
                        { x: playerPos.x + 1, y: playerPos.y },
                        { x: playerPos.x - 1, y: playerPos.y },
                        { x: playerPos.x, y: playerPos.y + 1 },
                        { x: playerPos.x, y: playerPos.y - 1 },
                    ];
                    return adj.filter(p => 
                        p.x >= 0 && p.x < GRID_SIZE && 
                        p.y >= 0 && p.y < GRID_SIZE && 
                        isWalkable(p.x, p.y)
                    );
                };

                const handleMove = (x, y) => {
                    if (gameState !== 'moving') return;
                    setPlayerPos({ x, y });
                    setMovesLeft(prev => prev - 1);
                    const room = ROOMS.find(r => x >= r.x && x < r.x + r.w && y >= r.y && y < r.y + r.h);
                    if (room) {
                        setMovesLeft(0);
                        triggerCard(room);
                    } else {
                        if (movesLeft <= 1) {
                            setGameState('idle');
                            setCurrentMessage("Pas assez de mouvements pour entrer. Relance les dés !");
                        }
                    }
                };

                const triggerCard = (room) => {
                    const availableCards = FULL_CARDS_DB.filter(card => !completedCards.includes(card.id));
                    if (availableCards.length === 0) {
                        setGameState('won');
                        return;
                    }
                    const randomIndex = Math.floor(Math.random() * availableCards.length);
                    const selectedCard = availableCards[randomIndex];
                    setGameState('quiz');
                    setActiveCard({ ...selectedCard, roomName: room.name });
                };

                const handleAnswer = (isCorrect) => {
                    if (isCorrect) {
                        setShowFeedback('success');
                        const newCompleted = [...completedCards, activeCard.id];
                        setLogoRotation(prev => prev + 1800);

                        setTimeout(() => {
                            setCompletedCards(newCompleted);
                            setActiveCard(null);
                            setShowFeedback(null);
                            if (newCompleted.length === FULL_CARDS_DB.length) {
                                setGameState('won');
                            } else {
                                setGameState('idle');
                                setCurrentMessage(`Bien joué ! Carte validée. Relance les dés.`);
                            }
                        }, 2500);
                    } else {
                        setShowFeedback('failure');
                        setTimeout(() => {
                            setShowFeedback(null);
                        }, 1500);
                    }
                };

                const renderGrid = () => {
                    const grid = [];
                    const reachable = getReachableTiles();
                    for (let y = 0; y < GRID_SIZE; y++) {
                        for (let x = 0; x < GRID_SIZE; x++) {
                            const room = ROOMS.find(r => x >= r.x && x < r.x + r.w && y >= r.y && y < r.y + r.h);
                            const isReachable = reachable.some(p => p.x === x && p.y === y);
                            grid.push(
                                <GridCell 
                                    key={`${x}-${y}`} 
                                    x={x} y={y} 
                                    isPath={isWalkable(x, y)}
                                    isRoom={!!room}
                                    roomData={room}
                                    playerPos={playerPos}
                                    isReachable={isReachable}
                                    onClick={handleMove}
                                />
                            );
                        }
                    }
                    return grid;
                };

                return (
                    <div className="h-screen bg-slate-950 text-white font-sans flex flex-col md:flex-row overflow-hidden">
                        <div className="w-full md:w-96 p-4 flex flex-col border-r border-slate-800 bg-slate-900 z-30 shadow-2xl overflow-y-auto">
                            <div className="mb-4 text-center md:text-left">
                                <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-pink-500 tracking-tighter leading-none mb-1">STUDOR</h1>
                                <p className="text-slate-400 text-xs uppercase tracking-widest leading-tight">Le jeu de l'orientation du Figaro Étudiant</p>
                            </div>

                            <div className="bg-slate-800 p-3 rounded-xl mb-3 border border-slate-700 shadow-inner">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-xs font-bold uppercase text-slate-400 flex items-center gap-1"><CheckCircle className="w-3 h-3"/> Progression</span>
                                    <span className="bg-blue-600 text-xs font-bold px-2 py-0.5 rounded-full text-white">{completedCards.length} / {FULL_CARDS_DB.length}</span>
                                </div>
                                <div className="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden">
                                    <div className="bg-gradient-to-r from-blue-500 to-purple-500 h-full transition-all duration-500" style={{ width: `${(completedCards.length / FULL_CARDS_DB.length) * 100}%` }} />
                                </div>
                                <p className="text-xs font-medium text-slate-200 mt-2 leading-snug">{currentMessage}</p>
                            </div>

                            <div className="mb-6 flex flex-col items-center justify-center">
                                {/* ZONE DÉS 3D */}
                                <div className="flex justify-center mb-4 h-24">
                                    <Dice3D value={diceValues[0]} rolling={isRolling} />
                                    <Dice3D value={diceValues[1]} rolling={isRolling} />
                                </div>

                                {(gameState === 'start' || gameState === 'idle') && (
                                    <button onClick={handleRollDice} className="w-full py-3 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 rounded-xl shadow-lg shadow-red-900/50 transition-all transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2 font-black text-lg text-white">
                                        <DiceIcon className="w-6 h-6" /> LANCER LES DÉS
                                    </button>
                                )}
                                
                                {gameState === 'moving' && (
                                    <div className="text-center w-full py-2 bg-slate-800 rounded-lg border border-slate-700">
                                        <span className="text-slate-400 text-xs uppercase block">Déplacements</span>
                                        <div className="text-2xl font-bold text-white flex justify-center gap-4">
                                            <span>{diceValues[0]}</span> + <span>{diceValues[1]}</span> = <span className="text-yellow-400">{movesLeft}</span>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {activeCard && (
                                <div className="flex-1 flex flex-col relative animate-in slide-in-from-bottom duration-500">
                                    <div className="bg-white text-slate-900 rounded-xl p-4 shadow-[0_0_30px_rgba(0,0,0,0.5)] border-t-8 border-yellow-400 flex flex-col h-full">
                                        <div className="flex justify-between items-start mb-3">
                                            <span className="bg-yellow-100 text-yellow-800 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider">{activeCard.roomName}</span>
                                        </div>
                                        <h2 className="text-lg font-black mb-2 text-indigo-900 leading-tight">{activeCard.title}</h2>
                                        <p className="text-sm mb-4 font-medium text-slate-600 leading-relaxed">{activeCard.question}</p>
                                        <div className="space-y-2 mb-4 overflow-y-auto max-h-60 custom-scrollbar">
                                            {activeCard.options.map((opt, idx) => (
                                                <button key={idx} onClick={() => handleAnswer(opt.correct)} className="w-full text-left p-3 rounded-lg border-2 border-slate-100 bg-slate-50 hover:border-indigo-500 hover:bg-indigo-50 transition-all text-sm font-medium flex items-start group">
                                                    <span className="flex-shrink-0 w-5 h-5 rounded-full border-2 border-slate-300 mr-3 flex items-center justify-center group-hover:border-indigo-500 text-[10px] text-slate-400 font-bold mt-0.5">{String.fromCharCode(65 + idx)}</span>
                                                    {opt.text}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    {showFeedback && (
                                        <div className={`absolute inset-0 rounded-xl flex flex-col items-center justify-center bg-white/95 backdrop-blur-sm z-20 text-center p-4 transition-opacity duration-300`}>
                                            {showFeedback === 'success' ? (
                                                <>
                                                    <CheckCircle className="w-12 h-12 text-green-500 mb-2 animate-bounce" />
                                                    <h3 className="text-lg font-bold text-green-800">C'est exact !</h3>
                                                    <p className="text-xs text-slate-500 mt-2 italic bg-slate-100 p-2 rounded border border-slate-200">{activeCard.explanation}</p>
                                                </>
                                            ) : (
                                                <>
                                                    <XCircle className="w-12 h-12 text-red-500 mb-2 animate-shake" />
                                                    <h3 className="text-lg font-bold text-red-800">Aïe, non...</h3>
                                                    <p className="text-sm text-red-600">Essaie encore !</p>
                                                </>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}

                            {gameState === 'won' && (
                                <div className="flex-1 bg-gradient-to-br from-yellow-300 to-orange-500 rounded-xl p-6 shadow-2xl flex flex-col items-center justify-center text-center animate-in zoom-in duration-500">
                                    <Trophy className="w-20 h-20 text-white drop-shadow-md mb-4" />
                                    <h2 className="text-2xl font-black text-white mb-2 drop-shadow-sm">GRAND CHELEM !</h2>
                                    <p className="text-white font-medium text-sm mb-6">Tu maîtrises tout le lexique de l'étudiant.</p>
                                    <button onClick={() => window.location.reload()} className="bg-white text-orange-600 px-6 py-2 rounded-full font-bold shadow-lg hover:scale-105 transition-transform text-sm">Rejouer une partie</button>
                                </div>
                            )}
                        </div>

                        <div className="flex-1 relative bg-slate-950 p-2 md:p-6 overflow-auto flex items-center justify-center min-h-[50vh]">
                            <div 
                                className="relative grid gap-[1px] bg-slate-800 shadow-2xl rounded-xl overflow-hidden border-8 border-slate-800 ring-1 ring-slate-700"
                                style={{
                                    gridTemplateColumns: `repeat(${GRID_SIZE}, minmax(0, 1fr))`,
                                    gridTemplateRows: `repeat(${GRID_SIZE}, minmax(0, 1fr))`,
                                    width: 'min(95vh, 100%)',
                                    aspectRatio: '1/1'
                                }}
                            >
                                {ROOMS.map(room => <RoomOverlay key={room.id} room={room} playerPos={playerPos} />)}
                                {renderGrid()}
                                <div className="absolute bg-slate-950 flex flex-col items-center justify-center z-0" style={{ gridColumnStart: 6, gridColumnEnd: 11, gridRowStart: 6, gridRowEnd: 11 }}>
                                    <div className="w-full h-full transition-transform duration-[2500ms] ease-out" style={{ transform: `rotate(${logoRotation}deg)` }}>
                                        <FigaroLogo />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<StudorGame />);
        } catch (err) {
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-display').innerHTML = "<strong>Erreur d'exécution React :</strong><br>" + err.message;
        }
    </script>
</body>
</html>